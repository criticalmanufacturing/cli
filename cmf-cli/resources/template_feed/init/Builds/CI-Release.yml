# CM PI Continuous Integration Release Pipeline
pool:
  name: <%= $CLI_PARAM_AgentPool %>
<%
  if ( $CLI_PARAM_AgentType -eq "Cloud") {
    "  vmImage: 'ubuntu-latest'"    
  }
%>

# A pipeline with no CI trigger
trigger: none

# A pipeline with no PR trigger
pr: none

# Pipeline tiggered by CI-Publish
resources:
 pipelines:
   - pipeline: CIPublish
     source: CI-Publish
     branch: $(Build.SourceBranch)
     trigger:
      branches:
       include:
         - development

variables:
 - template: ../EnvironmentConfigs/GlobalVariables.yml  # Template reference to global variables
 - name: RestoreIdentifier
   value: 'ORIGINAL'

# Setted in runtime
parameters:
- name: Environment
  displayName: AzureDevOps Environment name
  type: string
  default: <%= $CLI_PARAM_EnvironmentName %>
  values:
  - <%= $CLI_PARAM_EnvironmentName %>
- name: RunSettings
  displayName: RunSettings file name
  type: string
  default: integration.runsettings
  values:
  - integration.runsettings
- name: EnvironmentConfigName
  displayName: EnvironmentConfig file name
  type: string
  default: <%= $CLI_PARAM_ReleaseEnvironmentConfig %>
  values:
  - <%= $CLI_PARAM_ReleaseEnvironmentConfig %>
# Stages to Run
- name: executeAllStages
  displayName: ExecuteAllStages
  type: boolean
  default: true
- name: RestoreEnvironment
  displayName: RestoreEnvironment
  type: boolean
  default: false
- name: CustomizationInstall
  displayName: CustomizationInstall
  type: boolean
  default: false
- name: RestorePoint
  displayName: RestorePoint
  type: boolean
  default: false
- name: RunTestMasterData
  displayName: RunTestMasterData
  type: boolean
  default: false
- name: DailyBackup
  displayName: DailyBackup
  type: boolean
  default: false
- name: RunTests
  displayName: RunTests
  type: boolean
  default: false
- name: ApprovalAndRetain
  displayName: ApprovalAndRetain
  type: boolean
  default: false
- name: RenameRestorePoint
  displayName: RenameRestorePoint
  type: boolean
  default: false

name: Release-$(Build.BuildId)
stages:
  - stage: "RestoreEnvironment"
    displayName: "Restore Environment"
    condition: or( eq('${{ parameters.executeAllStages }}', true), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.RestoreEnvironment }}', true) ) )
    jobs:
      - job: "RestoreEnvironment"
        displayName: "Restore Environment"
        workspace:
          clean: all
        steps:
          - checkout: none

          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'
          
          # Download Build Artifacts - BackupRestore Tools
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifacts - BackupRestore Tools'
            inputs:
              buildType: specific
              project: 'COMMON'
              pipeline: 'CI-BackupRestoreTools'
              specificBuildWithTriggering: true
              buildVersionToDownload: latestFromBranch
              branchName: '${{ variables.CommonBranch }}'
              downloadType: specific
              downloadPath: 'DownloadPackages'
              artifactName: Cmf.BackupRestore.Tools
          # Extract files - BackupRestoreTools
          - task: ExtractFiles@1
            displayName: "Extract files - Pre-Package"
            inputs:
              archiveFilePatterns: "Cmf.BackupRestore.Tools.*.zip"
              destinationFolder: "BackupRestoreTools"
              cleanDestinationFolder: true
            continueOnError: false

          # Copy EnvironmentConfig to Server
          - task: CopyFiles@2
            displayName: 'Copy EnvironmentConfig to Server'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations/EnvironmentConfigs
              Contents: '${{ parameters.EnvironmentConfigName }}.json'
              TargetFolder: BackupRestoreTools/EnvironmentConfigs

          # Restore DB
          - task: PowerShell@2
            displayName: "Restore DB"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: '.\BackupRestoreTools\DeploymentTools\SystemRestore.ps1'
              arguments: '-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -InteractiveMode:$false -restoreIdentifier "$(RestoreIdentifier)" -FullRestore:$false -RestoreDBOnline:$true -RestoreDBODS:$true -RestoreDBDWH:$true -doNotStopHosts:$true'
            continueOnError: false

          # Restore Business Tier
          - task: PowerShell@2
            displayName: "Restore Business Tier"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: '.\BackupRestoreTools\DeploymentTools\SystemRestore.ps1'
              arguments: '-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -InteractiveMode:$false -restoreIdentifier "$(RestoreIdentifier)" -FullRestore:$false -RestoreBusiness:$true'
            continueOnError: false

          # Restore HTML
          - task: PowerShell@2
            displayName: "Restore HTML"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: '.\BackupRestoreTools\DeploymentTools\SystemRestore.ps1'
              arguments: '-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -InteractiveMode:$false -restoreIdentifier "$(RestoreIdentifier)" -FullRestore:$false -RestoreUIHtml:$true -doNotStopHosts:$true'
            continueOnError: false

          # Restore Help
          - task: PowerShell@2
            displayName: "Restore Help"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: '.\BackupRestoreTools\DeploymentTools\SystemRestore.ps1'
              arguments: '-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -InteractiveMode:$false -restoreIdentifier "$(RestoreIdentifier)" -FullRestore:$false -RestoreUIHelp:$true -doNotStopHosts:$true'
            continueOnError: false
            
          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()

  - stage: "CustomizationInstall"
    displayName: "Customization Install"
    condition: or( and( eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.CustomizationInstall }}', true) ) )
    jobs:
      - job: "CustomizationInstall"
        displayName: "Customization Install"
        workspace:
          clean: all
        steps:
          - checkout: none

          # Clean deploy folder
          - task: DeleteFiles@1
            displayName: 'Clean deploy folder'
            inputs:
              SourceFolder: '${{ variables.DeploymentPath }}/Deploy'
              Contents: '**'

          # Download Package Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Package Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package'
              downloadPath: '${{ variables.DeploymentPath }}/Deploy'
          
          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'

          # Copy EnvironmentConfig to Server
          - task: CopyFiles@2
            displayName: 'Copy EnvironmentConfig to Server'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations/EnvironmentConfigs
              Contents: '${{ parameters.EnvironmentConfigName }}.json'
              TargetFolder: ${{ variables.DeploymentPath }}/Deploy

          # Customization Installation
          - task: PowerShell@2
            displayName: "Customization Installation"
            inputs:
              pwsh: false
              arguments: "-ImagePath '${{ variables.ISOImagePath }}' -EnvironmentConfigName '${{ parameters.EnvironmentConfigName }}' -PackageSource '${{ variables.DeploymentPath }}/Deploy'"
              targetType: 'inline'
              script: |
                $ImagePath = '${{ variables.ISOImagePath }}'; 
                $EnvironmentConfigName = '${{ parameters.EnvironmentConfigName }}';
                $PackageSource = '${{ variables.DeploymentPath }}/Deploy';
                
                # Assuming repository Checkout
                $EnvironmentConfig = "$EnvironmentConfigName.json";
                $EnvConfigFile = Get-Item "./Cmf.Custom.Package.Configurations/EnvironmentConfigs/$EnvironmentConfig"
                $EnvConfigJson = Get-Content -Raw -Path $EnvConfigFile | ConvertFrom-Json
                $ServerAddress = $EnvConfigJson.'Product.ApplicationServer.Address'
                $CmfPackageJsonFile = Get-Item "./Cmf.Custom.Package.Configurations/cmfpackage.json"
                $CmfPackageJson = Get-Content -Raw -Path $CmfPackageJsonFile | ConvertFrom-Json
                
                $PackageId = $CmfPackageJson.'packageId'
                $PackageVersion = $CmfPackageJson.'version'
                
                $sc = 
                {
                  param ($ImagePath, $PackageId, $PackageVersion, $PackageSource, $EnvironmentConfig)
              
                  # Mount the ISO, without having a drive letter auto-assigned
                  if (!(Get-DiskImage -ImagePath $ImagePath).Attached) {
                      Mount-DiskImage -ImagePath $ImagePath -PassThru
                  }
                
                    $driveLetter = (Get-DiskImage -ImagePath $ImagePath | Get-Volume).DriveLetter
                
                    $PackageSource = $PackageSource #+ '\' + $PackageVersion
                
                    Set-Location -Path $driveLetter':\'
                
                    $scriptPath = '.\tools\CmfDeploy.exe install ' + $PackageId + '@' + `
                        $PackageVersion + ' --parameters="' + $PackageSource + '\' + $EnvironmentConfig + '" --packageSource="' + $PackageSource + '" -logFileLocation "' + $PackageSource + '"'
                
                    Write-Host("Script to run: " + $scriptPath)
                
                    Invoke-Expression $scriptPath | Out-Host
                
                    Dismount-DiskImage -ImagePath $ImagePath
                    if($LASTEXITCODE)
                    {
                        throw "Installation Failed!"
                    }
                }
                
                try {      
                  $iso = Get-Item $ImagePath
                  $destPath = "${{ variables.DeploymentPath }}/isos/"
                  $destIso = "$destPath/" + $iso.Name

                  if (-Not (Test-Path $destIso)) {
                      New-Item -Type Directory -Path $destPath -Force -Verbose
                      Copy-Item -Path $iso -Destination $destIso -Force -Verbose
                  }
                  else {
                      Write-Host $destIso "already Exists"
                  }

                  Invoke-Command -ComputerName $ServerAddress -ScriptBlock $sc -ArgumentList @($destIso, $PackageId, $PackageVersion, $PackageSource, $EnvironmentConfig) | Out-Host
                }
                catch { throw (" *  Invoke-Command ERROR " + $_) }

          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()

  - stage: "RestorePoint"
    displayName: "Restore Point"
    condition: or( and( eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.RestorePoint }}', true) ) )
    jobs:
      - job: "RestorePoint"
        displayName: "Restore Point"
        workspace:
          clean: all
        steps:
          - checkout: none

          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'

          # Get package version
          - task: PowerShell@2
            displayName: 'Get package version'
            inputs:
              targetType: inline
              script: |
                $CmfPackageJsonFile = Get-Item "./Cmf.Custom.Package.Configurations/cmfpackage.json"
                $CmfPackageJson = Get-Content -Raw -Path $CmfPackageJsonFile | ConvertFrom-Json
                $PackVersion = $CmfPackageJson.'version'
                $PackageId = $CmfPackageJson.'packageId'
                Write-Host "PackVersion = $PackVersion"
                Write-Host "PackageId = $PackageId"
                echo "##vso[task.setvariable variable=PackageVersion;isOutput=true]$PackVersion"
                echo "##vso[task.setvariable variable=PackageId;isOutput=true]$PackageId"
            name: GetPackageVersion

          # BackupRestoreTools Artifact
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifacts - BackupRestore Tools'
            inputs:
              buildType: specific
              project: 'COMMON'
              pipeline: 'CI-BackupRestoreTools'
              specificBuildWithTriggering: true
              buildVersionToDownload: latestFromBranch
              branchName: '${{ variables.CommonBranch }}'
              downloadType: specific
              downloadPath: 'DownloadPackages'
              artifactName: Cmf.BackupRestore.Tools

          # Extract files - BackupRestoreTools
          - task: ExtractFiles@1
            displayName: "Extract files - BackupRestoreTools"
            inputs:
              archiveFilePatterns: "Cmf.BackupRestore.Tools.*.zip"
              destinationFolder: "BackupRestoreTools"
              cleanDestinationFolder: true
            continueOnError: false

          # Copy EnvironmentConfig to BackupRestoreTools
          - task: CopyFiles@2
            displayName: 'Copy EnvironmentConfig to BackupRestoreTools'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations/EnvironmentConfigs
              Contents: '${{ parameters.EnvironmentConfigName }}.json'
              TargetFolder: BackupRestoreTools/EnvironmentConfigs

          # Create Restore Point
          - task: PowerShell@2
            displayName: "Create Restore Point"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: './BackupRestoreTools/DeploymentTools/SystemBackup.ps1'
              arguments: "-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -backupIdentifier $(GetPackageVersion.PackageId)_$(GetPackageVersion.PackageVersion) -InteractiveMode:$false"
            continueOnError: false

          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()

  - stage: "RunTestMasterData"
    displayName: "Run Test Master Data"
    condition: or( and( eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.RunTestMasterData }}', true) ) )
    jobs:
      - job: "RunTestMasterData"
        displayName: "Run Test Master Data"
        workspace:
          clean: all
        steps:
          - checkout: none

          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'

          # Download Tests Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Tests Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Tests'
              downloadPath: '$(Build.SourcesDirectory)'
            continueOnError: true

          # Verify if Artifact exists - Tests
          - task: PowerShell@2
            displayName: Verify if Artifact exists - Tests
            inputs:
              targetType: inline
              script: |
                Write-Host "##vso[task.setVariable variable=ArtifactExists;]false"
                $artifactPath = "$(Build.SourcesDirectory)/Cmf.*.Tests/*.zip"
                Write-Host "$artifactPath"
                if (Get-ChildItem -Path $artifactPath)
                {
                  ls $artifactPath
                  Get-ChildItem $artifactPath | foreach { 
                    $targetDirectory = "$(Build.SourcesDirectory)/TestExecution/" + $_.BaseName
                    Write-Host "$_ -> $targetDirectory"
                    Expand-Archive $_ -DestinationPath $targetDirectory -Force 
                  }
                  Write-Host "##vso[task.setVariable variable=ArtifactExists;]true"
                }
                else
                {
                  Write-Host "If fails"
                }
                Write-Host "$Env:ArtifactExists"
          
          # Get Tests Master Data 
          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/TestExecution/'
              Contents: '*/MasterData/*'
              TargetFolder: '$(Build.SourcesDirectory)/TestExecution/MasterData'
              CleanTargetFolder: true
              flattenFolders: true
              OverWrite: false
            condition: eq(variables['ArtifactExists'], true)

          # Common Artifact
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifacts - Common Tools'
            inputs:
              buildType: specific
              project: 'COMMON'
              pipeline: 'COMMON-CI'
              specificBuildWithTriggering: true
              buildVersionToDownload: latestFromBranch
              branchName: '${{ variables.CommonBranch }}'
              downloadType: specific
              downloadPath: 'Artifacts'
              artifactName: Cmf.Custom.Tools
            condition: eq(variables['ArtifactExists'], true)
          
          # Extract files - Common Tools
          - task: ExtractFiles@1
            displayName: 'Extract files - Common Tools'
            inputs:
              archiveFilePatterns: 'Cmf.Custom.Tools.*.zip'
              destinationFolder: Package
              cleanDestinationFolder: true
            condition: eq(variables['ArtifactExists'], true)

          # Copy EnvironmentConfig to Package
          - task: CopyFiles@2
            displayName: 'Copy EnvironmentConfig to Package'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations/EnvironmentConfigs
              Contents: '${{ parameters.EnvironmentConfigName }}.json'
              TargetFolder: Package/EnvironmentConfigs
            condition: eq(variables['ArtifactExists'], true)

          # Copy LBOs to References
          - task: CopyFiles@2
            displayName: 'Copy LBOs to References'
            inputs:
              SourceFolder: 'Cmf.Custom.Package.Configurations/LBOs'
              Contents: |
                Cmf.LightBusinessObjects.dll
              TargetFolder: 'Package/CMFInstallActions/References'
            condition: eq(variables['ArtifactExists'], true)

          # Run Test Master Data
          - task: PowerShell@2
            displayName: "Run Test Master Data"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: './Package/DeploymentTools/RunMasterData.ps1'
              arguments: '-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -MasterDataFolderPath ''TestExecution\MasterData'' -AutomationWorkflowFilesPath ''TestExecution\MasterData\AutomationWorkflowFiles'' -ExportedObjectsFilesPath ''TestExecution\MasterData\ExportedObjects'''
            continueOnError: false
            condition: eq(variables['ArtifactExists'], true)
          
          # Restart Host
          - task: PowerShell@2
            displayName: "Restart Host"
            inputs:
              pwsh: false
              targetType: inline
              script: |
                $packageRootFolder = "./Package/" # change to match package root folder
                $cmfInstallActionsFolder = "$packageRootFolder/CMFInstallActions"
                $jsonConfigFilePath = "$packageRootFolder/EnvironmentConfigs/${{ parameters.EnvironmentConfigName }}.json"
                Import-Module $cmfInstallActionsFolder/CMFInstallActions.psd1
                $env = (Get-CMFEnvironment -environmentConfigPath $jsonConfigFilePath -cmfInstallActionsPath $cmfInstallActionsFolder)
                Stop-NavigoHosts $env -disableNLBManagement
                Start-NavigoHosts $env -disableNLBManagement
            continueOnError: false
          
          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()

  - stage: "DailyBackup"
    displayName: "Daily Backup"
    condition: or( and( eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.DailyBackup }}', true) ) )
    jobs:
      - job: "DailyBackup"
        displayName: "Daily Backup"
        workspace:
          clean: all
        steps:
          - checkout: none

          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'

          # BackupRestoreTools Artifact
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifacts - BackupRestore Tools'
            inputs:
              buildType: specific
              project: 'COMMON'
              pipeline: 'CI-BackupRestoreTools'
              specificBuildWithTriggering: true
              buildVersionToDownload: latestFromBranch
              branchName: '${{ variables.CommonBranch }}'
              downloadType: specific
              downloadPath: 'DownloadPackages'
              artifactName: Cmf.BackupRestore.Tools

          # Extract files - BackupRestoreTools
          - task: ExtractFiles@1
            displayName: "Extract files - BackupRestoreTools"
            inputs:
              archiveFilePatterns: "Cmf.BackupRestore.Tools.*.zip"
              destinationFolder: "BackupRestoreTools"
              cleanDestinationFolder: true
            continueOnError: false

          # Copy EnvironmentConfig to BackupRestoreTools
          - task: CopyFiles@2
            displayName: 'Copy EnvironmentConfig to BackupRestoreTools'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations/EnvironmentConfigs
              Contents: '${{ parameters.EnvironmentConfigName }}.json'
              TargetFolder: BackupRestoreTools/EnvironmentConfigs

          # Create Restore Point - DailyBackup
          - task: PowerShell@2
            displayName: "Create Restore Point - DailyBackup"
            inputs:
              pwsh: false
              targetType: filePath
              filePath: './BackupRestoreTools/DeploymentTools/SystemBackup.ps1'
              arguments: "-EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -backupIdentifier 'DailyBackup' -InteractiveMode:$false -FullBackup:$false -BackupDBOnline:$true -doNotStopHosts:$true"
            continueOnError: false

          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()

  - stage: "RunTests"
    displayName: "Run Tests"
    condition: or( and( eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.RunTests }}', true) ) )
    jobs:
      - job: "RunTests"
        timeoutInMinutes: 720 # 12 hours
        displayName: "Run Tests"
        workspace:
          clean: all
        steps:
          - checkout: none
            
          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'
          
          # Copy Copy global.json to root
          - task: CopyFiles@2
            displayName: 'Copy global.json to root'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations
              Contents: 'global.json'
              TargetFolder: '.'

          # Download Tests Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Tests Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Tests'
              downloadPath: '$(Build.SourcesDirectory)'
            continueOnError: true

          # Verify if Artifact exists - Tests
          - task: PowerShell@2
            displayName: Verify if Artifact exists - Tests
            inputs:
              targetType: inline
              script: |
                Write-Host "##vso[task.setVariable variable=ArtifactExists;]false"
                $artifactPath = "$(Build.SourcesDirectory)/Cmf.*.Tests/*.zip"
                Write-Host "$artifactPath"
                if (Get-ChildItem -Path $artifactPath)
                {
                  ls $artifactPath
                  Get-ChildItem $artifactPath | foreach { 
                    $targetDirectory = "$(Build.SourcesDirectory)/TestExecution/" + $_.BaseName
                    Write-Host "$_ -> $targetDirectory"
                    Expand-Archive $_ -DestinationPath $targetDirectory -Force 
                  }
                  Write-Host "##vso[task.setVariable variable=ArtifactExists;]true"
                }
                else
                {
                  Write-Host "If fails"
                }
                Write-Host "$Env:ArtifactExists"

          # UseDotNet
          - task: UseDotNet@2
            displayName: 'Use Repository specified .NET Core version'
            inputs:
              packageType: 'sdk'
              useGlobalJson: true

          # Copy RunSettings to TestExecution
          - task: CopyFiles@2
            displayName: 'Copy RunSettings to TestExecution'
            inputs:
              SourceFolder: Cmf.Custom.Package.Configurations
              Contents: 'RunSettings/**'
              TargetFolder: 'TestExecution'
            
          # Run Tests - Business
          - task: VSTest@2
            displayName: "Run Tests - Business"
            inputs:
              testAssemblyVer2: '**\*.Biz.dll'
              searchFolder: $(System.DefaultWorkingDirectory)
              resultsFolder: '$(Agent.TempDirectory)\TestResults'
              runSettingsFile: 'TestExecution\RunSettings\${{ parameters.RunSettings }}'
              testRunTitle: "Business Tests"
              rerunFailedTests: true
              rerunType: "basedOnTestFailurePercentage" # Optional. Options: basedOnTestFailurePercentage, basedOnTestFailureCount
              rerunFailedThreshold: "30"
              rerunMaxAttempts: "3"
            continueOnError: true
            condition: eq(variables['ArtifactExists'], true)

          # Run Tests - HTML
          - task: VSTest@2
            displayName: "Run Tests - HTML"
            inputs:
              testAssemblyVer2: '**\*.GUI.dll'
              searchFolder: $(System.DefaultWorkingDirectory)
              resultsFolder: '$(Agent.TempDirectory)\TestResults'
              runSettingsFile: 'TestExecution\RunSettings\${{ parameters.RunSettings }}'
              testRunTitle: "HTML Tests"
              rerunFailedTests: true
              rerunType: "basedOnTestFailurePercentage" # Optional. Options: basedOnTestFailurePercentage, basedOnTestFailureCount
              rerunFailedThreshold: "30"
              rerunMaxAttempts: "3"
            continueOnError: true
            condition: eq(variables['ArtifactExists'], true)

          # Run Tests - IoT
          - task: VSTest@2
            displayName: "Run Tests - IoT"
            inputs:
              testAssemblyVer2: '**\*.IoT.dll'
              searchFolder: $(System.DefaultWorkingDirectory)
              resultsFolder: '$(Agent.TempDirectory)\TestResults'
              platform: latest
              runSettingsFile: 'TestExecution\RunSettings\${{ parameters.RunSettings }}'
              testRunTitle: "IoT Tests"
              rerunFailedTests: true
              rerunType: "basedOnTestFailurePercentage" # Optional. Options: basedOnTestFailurePercentage, basedOnTestFailureCount
              rerunFailedThreshold: "30"
              rerunMaxAttempts: "3"
            continueOnError: true
            condition: eq(variables['ArtifactExists'], true)
          
          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()

  - stage: "ApprovalAndRetain"
    displayName: "Approval and Retain"
    condition: or( and( eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.ApprovalAndRetain }}', true) ) )
    jobs:
      - deployment:
        timeoutInMinutes: 2880 # 48 hours
        displayName: "Approval and Retain"
        workspace:
          clean: all
        environment: ${{ parameters.Environment }}
        cancelTimeoutInMinutes: 2880 # 48 hours
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: none
                      
                # Download Configurations Artifacts
                - task: DownloadBuildArtifacts@0
                  displayName: "Download Configurations Artifacts"
                  inputs:
                    buildType: 'specific'
                    project: '<%= $CLI_PARAM_ProjectName %>'
                    pipeline: 'CI-Publish'
                    specificBuildWithTriggering: true
                    buildVersionToDownload: 'latestFromBranch'
                    allowPartiallySucceededBuilds: true
                    branchName: '$(Build.SourceBranch)'
                    downloadType: 'single'
                    artifactName: 'Cmf.Custom.Package.Configurations'
                    downloadPath: '.'
                  
                # Get package version
                - task: PowerShell@2
                  displayName: 'Get package version'
                  inputs:
                    targetType: inline
                    script: |
                      $CmfPackageJsonFile = Get-Item "./Cmf.Custom.Package.Configurations/cmfpackage.json"
                      $CmfPackageJson = Get-Content -Raw -Path $CmfPackageJsonFile | ConvertFrom-Json
                      $PackVersion = $CmfPackageJson.'version'
                      $PackageId = $CmfPackageJson.'packageId'
                      Write-Host "PackVersion = $PackVersion"
                      Write-Host "PackageId = $PackageId"
                      echo "##vso[task.setvariable variable=PackageVersion;isOutput=true]$PackVersion"
                      echo "##vso[task.setvariable variable=PackageId;isOutput=true]$PackageId"
                  name: GetPackageVersion

                # Get Date
                - task: PowerShell@2
                  displayName: "Get Date"
                  inputs:
                    pwsh: false
                    targetType: inline
                    script: |
                      $date=$(Get-Date -Format "yyyyMMdd");
                      Write-Host "##vso[task.setvariable variable=time]$date"
                  continueOnError: false

                # Tag Git Source
                - task: git-tag-on-release-task@9
                  displayName: "Tag Git Source"
                  inputs:
                    staticTagName: "<%= $CLI_PARAM_Tenant %>-$(time)-$(GetPackageVersion.PackageVersion)"

                # Retain indefinitely current release
                - task: retainPipeline@3
                  displayName: "Retain indefinitely current release"
                  inputs:
                    lock: true

                # Download Package Artifacts
                - task: DownloadBuildArtifacts@0
                  displayName: "Download Package Artifacts"
                  inputs:
                    buildType: 'specific'
                    project: '<%= $CLI_PARAM_ProjectName %>'
                    pipeline: 'CI-Publish'
                    specificBuildWithTriggering: true
                    buildVersionToDownload: 'latestFromBranch'
                    allowPartiallySucceededBuilds: true
                    branchName: '$(Build.SourceBranch)'
                    downloadType: 'single'
                    artifactName: 'Cmf.Custom.Package'
                    downloadPath: 'PackageApproved'
                                
                # Copy generated Packges to Repository
                - task: CopyFiles@2
                  displayName: 'Copy generated Packges From Repository'
                  inputs:
                    SourceFolder: 'PackageApproved'
                    Contents: |
                      *.zip
                    TargetFolder: '${{ variables.ProjectPackageRepository }}/Delivered'
                    OverWrite: false

                # Download Tests Artifacts
                - task: DownloadBuildArtifacts@0
                  displayName: "Download Tests Artifacts"
                  inputs:
                    buildType: 'specific'
                    project: '<%= $CLI_PARAM_ProjectName %>'
                    pipeline: 'CI-Publish'
                    specificBuildWithTriggering: true
                    buildVersionToDownload: 'latestFromBranch'
                    allowPartiallySucceededBuilds: true
                    branchName: '$(Build.SourceBranch)'
                    downloadType: 'single'
                    artifactName: 'Cmf.Custom.Package.Tests'
                    downloadPath: 'TestPackageApproved'
                                
                # Copy generated Packges to Repository
                - task: CopyFiles@2
                  displayName: 'Copy generated Packges To Repository'
                  inputs:
                    SourceFolder: 'TestPackageApproved/Cmf.Custom.Package.Tests'
                    Contents: |
                      *.zip
                    TargetFolder: '${{ variables.ProjectPackageRepository }}/Delivered'
                    OverWrite: false

                # Clean
                - task: PostBuildCleanup@3
                  displayName: "Clean Agent Directories"
                  condition: always()

  - stage: "RenameRestorePoint"
    displayName: "Rename RestorePoint to ORIGINAL"
    condition: or( and( eq('${{ variables.SetNewRestorePoint }}', true), eq('${{ parameters.executeAllStages }}', true), succeeded() ), and( eq('${{ parameters.executeAllStages }}', false), eq('${{ parameters.RenameRestorePoint }}', true) ) )
    jobs:
      - job: "RenameRestorePoint"
        displayName: "Rename RestorePoint to ORIGINAL"
        workspace:
          clean: all
        steps:
          - checkout: none

          # Download Configurations Artifacts
          - task: DownloadBuildArtifacts@0
            displayName: "Download Configurations Artifacts"
            inputs:
              buildType: 'specific'
              project: '<%= $CLI_PARAM_ProjectName %>'
              pipeline: 'CI-Publish'
              specificBuildWithTriggering: true
              buildVersionToDownload: 'latestFromBranch'
              allowPartiallySucceededBuilds: true
              branchName: '$(Build.SourceBranch)'
              downloadType: 'single'
              artifactName: 'Cmf.Custom.Package.Configurations'
              downloadPath: '.'
            
          # Get package version
          - task: PowerShell@2
            displayName: 'Get package version'
            inputs:
              targetType: inline
              script: |
                $CmfPackageJsonFile = Get-Item "./Cmf.Custom.Package.Configurations/cmfpackage.json"
                $CmfPackageJson = Get-Content -Raw -Path $CmfPackageJsonFile | ConvertFrom-Json
                $PackVersion = $CmfPackageJson.'version'
                $PackageId = $CmfPackageJson.'packageId'
                Write-Host "PackVersion = $PackVersion"
                Write-Host "PackageId = $PackageId"
                echo "##vso[task.setvariable variable=PackageVersion;isOutput=true]$PackVersion"
                echo "##vso[task.setvariable variable=PackageId;isOutput=true]$PackageId"
            name: GetPackageVersion

          # Rename RestorePoint to ORIGINAL
          - task: PowerShell@2
            displayName: "Rename RestorePoint to ORIGINAL"
            inputs:
              pwsh: false
              targetType: inline
              failOnStderr: true
              script: |
                $EnvironmentConfig = "${{ parameters.EnvironmentConfigName }}.json";
                $EnvConfigFile = Get-Item "./Cmf.Custom.Package.Configurations/EnvironmentConfigs/$EnvironmentConfig"
                $EnvConfigJson = Get-Content -Raw -Path $EnvConfigFile | ConvertFrom-Json
                $BackupLocation = $EnvConfigJson.'Product.Database.BackupShare'

                Set-Location $BackupLocation -Verbose

                $originalKeyword = "$(RestoreIdentifier)"
                $restorePointKeyword = "$(GetPackageVersion.PackageId)_$(GetPackageVersion.PackageVersion)"
                $date = (Get-Date).ToString("yyyyMMdd")
                $oldRestorePointName = "Before-<%= $CLI_PARAM_Tenant %>-$date-$(GetPackageVersion.PackageVersion)"

                $originalFolderSearch = (Get-ChildItem -Filter $originalKeyword -Directory)
                $restorePointFolder =  (Get-ChildItem -Filter $restorePointKeyword -Directory)[0]

                # Rename Original Folder if exists
                if ($originalFolderSearch)
                {
                  $originalFolder =  (Get-ChildItem -Filter $originalKeyword -Directory)[0]
                  Rename-Item -Path $originalFolder -NewName $oldRestorePointName -Verbose -Force
                  Set-Location $oldRestorePointName -Verbose
                  $oldRestorePointFiles = Get-ChildItem -Filter "*$originalKeyword*" -File -Verbose
                  foreach ($oldRestorePointFile in $oldRestorePointFiles) {
                      Rename-Item -Path $oldRestorePointFile -NewName ($oldRestorePointFile.Name -replace $originalKeyword, $oldRestorePointName) -Verbose
                  }

                  Set-Location $BackupLocation -Verbose
                }
                
                Copy-Item -Path $restorePointFolder $originalKeyword -Verbose -Force -Recurse
                
                $originalFolder =  (Get-ChildItem -Filter $originalKeyword -Directory)[0]
                Set-Location $originalFolder -Verbose
                $restorePointFiles = Get-ChildItem -Filter "*$restorePointKeyword*" -File -Verbose
                foreach ($restorePointFile in $restorePointFiles) {
                    Rename-Item -Path $restorePointFile -NewName ($restorePointFile.Name -replace $restorePointKeyword, $originalKeyword) -Verbose -Force
                }

                Set-Location $BackupLocation -Verbose
            continueOnError: false
          
          # Clean
          - task: PostBuildCleanup@3
            displayName: "Clean Agent Directories"
            condition: always()