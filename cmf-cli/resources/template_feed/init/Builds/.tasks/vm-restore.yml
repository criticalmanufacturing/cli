parameters:
  EnvironmentConfigPath: ''
  EnvironmentConfigName: ''
  BackupRestoreIdentifier: ''
steps:
  - task: DownloadBuildArtifacts@0
    displayName: Download Common BackupRestoreTools
    inputs:
      buildType: specific
      project: COMMON
      pipeline: CI-BackupRestoreTools
      specificBuildWithTriggering: true
      buildVersionToDownload: latestFromBranch
      branchName: $(CommonBranch)
      downloadType: specific
      downloadPath: _CommonTools

  - task: ExtractFiles@1
    displayName: Extract Common BackupRestoreTools
    inputs:
      archiveFilePatterns: _CommonTools/Cmf.BackupRestore.Tools/*.zip
      destinationFolder: Package
      cleanDestinationFolder: true

  - powershell: |
      New-Item -Type Directory Package/EnvironmentConfigs -Force
      Copy-Item -Path "${{ parameters.EnvironmentConfigPath }}" -Destination Package/EnvironmentConfigs -Force -Verbose
    displayName: Copy ${{ parameters.EnvironmentConfigName }} to Package/EnvironmentConfigs

  - powershell: ./Package/DeploymentTools/SystemRestore.ps1 -EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -InteractiveMode:$false -restoreIdentifier ${{ parameters.BackupRestoreIdentifier }} -FullRestore:$false -RestoreDBOnline:$true -RestoreDBODS:$true -RestoreDBDWH:$true -doNotStopHosts:$true
    displayName: Restore - Database

  - powershell: ./Package/DeploymentTools/SystemRestore.ps1 -EnvironmentConfigName ${{ parameters.EnvironmentConfigName }} -InteractiveMode:$false -restoreIdentifier ${{ parameters.BackupRestoreIdentifier }} -FullRestore:$false -RestoreBusinessTier:$true -RestoreUIHtml:$true -RestoreUIHelp:$true
    displayName: Restore - Application Server